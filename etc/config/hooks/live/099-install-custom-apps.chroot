#!/bin/sh
# Description: Install custom Pacstall apps and others

# More pacstall specific things
export SUDO_USER=rhino
export DEBIAN_FRONTEND=noninteractive
export PACSTALL_DOWNLOADER=curl
export GITHUB_ACTIONS=true

sudo mkdir -p /var/log/pacstall/metadata /var/log/pacstall/error_log /tmp/pacstall /var/cache/pacstall /usr/src/pacstall
sudo chown "rhino" -cR "/var/log/pacstall"
sudo chmod -R 777 "/tmp/pacstall"
sudo chown "rhino" -cR "/usr/src/pacstall"
sudo chown "rhino" -cR "/tmp/pacstall"
sudo chown "rhino" -cR "/usr/share/pacstall"
sudo chown "rhino" -cR "/home/rhino"
sudo chown "rhino" -cR "/var/cache/pacstall"

sudo apt-get install epiphany-browser -yq

pushd /home/rhino
HOME=/home/rhino sudo runuser -m -u rhino -- sh -c 'pacstall -U pacstall develop'
HOME=/home/rhino sudo runuser -m -u rhino -- sh -c 'PACSTALL_DOWNLOADER=quiet-wget pacstall -PI nala-deb linux-headers-deb linux-headers-generic-arm64-deb linux-modules-arm64-deb linux-image-unsigned-arm64-deb'
HOME=/home/rhino sudo runuser -m -u rhino -- sh -c 'pacstall -PI rhino-linux-xfce4-config-git quintom-cursor-theme-git rhino-kvantum-theme-git rhino-plymouth-theme-git rhino-setup-git rhino-pkg-git rhino-neofetch-git'
popd

sudo sed -i 's/%sudo ALL=(ALL) NOPASSWD:ALL//' /etc/sudoers

sudo update-alternatives --install /usr/share/icons/default/index.theme x-cursor-theme /usr/share/icons/Quintom_Snow/cursor.theme 55
sudo update-alternatives --install /usr/share/icons/default/index.theme x-cursor-theme /usr/share/icons/Quintom_Ink/cursor.theme 55
sudo update-alternatives --install /usr/share/plymouth/themes/default.plymouth default.plymouth /usr/share/plymouth/themes/rhino-spinner/rhino-spinner.plymouth 100
sudo update-alternatives --set default.plymouth /usr/share/plymouth/themes/rhino-spinner/rhino-spinner.plymouth
sudo update-alternatives --set x-cursor-theme /usr/share/icons/Quintom_Ink/cursor.theme
echo "export QT_STYLE_OVERRIDE=kvantum" | sudo tee -a /etc/environment > /dev/null
mkdir -p /home/rhino/.config/Kvantum
mkdir -p /etc/skel/.config/Kvantum
mkdir -p /etc/skel/.config/gtk-4.0
mkdir -p /home/rhino/.config/gtk-4.0
echo "theme=KvRhinoDark" >> /home/rhino/.config/Kvantum/kvantum.kvconfig
echo "theme=KvRhinoDark" >> /etc/skel/.config/Kvantum/kvantum.kvconfig
echo "[Settings]
gtk-application-prefer-dark-theme=1" >> /etc/skel/.config/gtk-4.0/settings.ini
echo "[Settings]
gtk-application-prefer-dark-theme=1" >> /home/rhino/.config/gtk-4.0/settings.ini
xfconf-query -c xsettings -p /Net/ThemeName --set "Yaru-purple-dark"
xfconf-query -c xsettings -p /Gtk/CursorThemeName -s "Quintom_Ink"
xfconf-query -c xfwm4 -p /general/theme -s "Yaru-dark"
sudo sed -i "s/'default'/'prefer-dark'/g" /usr/share/glib-2.0/schemas/org.gnome.desktop.interface.gschema.xml
cd /usr/share/glib-2.0/schemas
sudo glib-compile-schemas .
cd ~

mkdir -p /home/rhino/Desktop
echo '[Desktop Entry]
Type=Application
Version=1.0
Name=Install Rhino Linux 23.04
Name[ar]=تنصيب لوبينتو 23.04
Name[ca]=Instal·lar Rhino Linux 23.04
Name[da]=Installer Rhino Linux 23.04
Name[de]=Rhino Linux 23.04 installieren
Name[es]=Instalar Rhino Linux 23.04
Name[fr]=Installer Rhino Linux 23.04
Name[it]=Installa Rhino Linux 23.04
Name[no]=Installer Rhino Linux 23.04
Name[pl]=Zainstaluj Rhino Linux 23.04
Name[pt]=Instalar o Rhino Linux 23.04
Name[pt_BR]=Instalar Rhino Linux 23.04
GenericName=Install Rhino Linux
GenericName[ar]=تنصيب لوبينتو
GenericName[ca]=Instal·lar Rhino Linux
GenericName[da]=Installer Rhino Linux
GenericName[de]=Rhino Linux installieren
GenericName[es]=Instalar Rhino Linux
GenericName[fr]=Installer Rhino Linux
GenericName[it]=Installa Rhino Linux
GenericName[no]=Installer Rhino Linux
GenericName[pl]=Zainstaluj Rhino Linux
GenericName[pt]=Instalar o Rhino Linux
GenericName[pt_BR]=Instalar Rhino Linux
Exec=sudo -E calamares -D6
Comment=Calamares — System Installer
Comment[ar]=الحبار — منصب النظام
Comment[ca]=Calamares — Instal·lador del Sistema
Comment[da]=Calamares - System installation
Comment[de]=Calamares — System Installer
Comment[es]=Calamares — Instalador del Sistema
Comment[fr]=Calamares  — Installateur de votre system
Comment[it]=Calamares — Installatore del Sistema
Comment[no]=Calamares — System installerer
Comment[pl]=Calamares — Instalator systemu
Comment[pt]=Calamares — Instalador do Sistema
Comment[pt_BR]=Calamares — Instalador do sistema
Icon=/usr/share/icons/logo.svg
Terminal=false
StartupNotify=true
Categories=Qt;System;
Keywords=installer;calamares;system;' | tee -a /usr/share/applications/install.desktop > /dev/null
sudo chmod 755 /usr/share/applications/install.desktop
sudo ln -s /usr/share/applications/install.desktop /home/rhino/Desktop/install.desktop
sudo chown "rhino" -cR /usr/share/applications/install.desktop

mkdir -p /etc/skel/.config/autostart
sudo rm /etc/calamares/modules/after_bootloader_context.conf
echo '---
dontChroot: false
timeout: 120
firmwareType:
    "*":
        - "-rm /usr/share/applications/install.desktop"
        - command: "-ln -s /usr/local/share/applications/org.rhinolinux.RhinoSetup.desktop /home/$USER/.config/autostart/setup.desktop"' | sudo tee -a /etc/calamares/modules/after_bootloader_context.conf > /dev/null

echo '#!/bin/sh
true' | sudo tee /usr/bin/calamares-logs-helper > /dev/null

( cd /etc/calamares/branding && sudo git clone https://github.com/rhino-linux/calamares rhino )
sudo sed -i 's/lubuntu/rhino/g' /etc/calamares/settings.conf

sudo rm /etc/calamares/modules/*386*.conf
sudo rm /etc/calamares/modules/automirror.conf
sudo rm /lib/aarch64-linux-gnu/calamares/modules/automirror -r
cd /lib/aarch64-linux-gnu/calamares/modules/
sudo git clone https://github.com/oklopfer/automirror/ -b arm64
sudo cp /lib/aarch64-linux-gnu/calamares/modules/automirror/automirror.conf /etc/calamares/modules/automirror.conf
cd ~

sudo rm /etc/lightdm/lightdm-gtk-greeter.conf
( cd /etc/lightdm/ && sudo wget https://raw.githubusercontent.com/rhino-linux/lightdm/main/lightdm-gtk-greeter.conf && sudo wget https://github.com/rhino-linux/lightdm/raw/main/rhino-blur.png )

sudo echo 'favorites=org.gnome.Epiphany.desktop,xfce4-file-manager.desktop,xfce4-terminal-emulator.desktop
recent=org.gnome.Epiphany.desktop,xfce4-terminal.desktop,xfce4-terminal-emulator.desktop,xfce4-file-manager.desktop,thunar.desktop,xfce-keyboard-settings.desktop,xfce4-mail-reader.desktop
button-icon=logo
button-single-row=false
show-button-title=false
show-button-icon=true
launcher-show-name=true
launcher-show-description=true
launcher-show-tooltip=true
launcher-icon-size=2
hover-switch-category=false
category-show-name=true
category-icon-size=1
sort-categories=true
view-mode=1
default-category=0
recent-items-max=10
favorites-in-recent=true
position-search-alternate=false
position-commands-alternate=false
position-categories-alternate=false
position-categories-horizontal=false
stay-on-focus-out=false
profile-shape=0
confirm-session-command=true
menu-width=450
menu-height=500
menu-opacity=100
command-settings=xfce4-settings-manager
show-command-settings=true
command-lockscreen=xflock4
show-command-lockscreen=true
command-switchuser=dm-tool switch-to-greeter
show-command-switchuser=false
command-logoutuser=xfce4-session-logout --logout --fast
show-command-logoutuser=false
command-restart=xfce4-session-logout --reboot --fast
show-command-restart=false
command-shutdown=xfce4-session-logout --halt --fast
show-command-shutdown=false
command-suspend=xfce4-session-logout --suspend
show-command-suspend=false
command-hibernate=xfce4-session-logout --hibernate
show-command-hibernate=false
command-logout=xfce4-session-logout
show-command-logout=true
command-menueditor=menulibre
show-command-menueditor=true
command-profile=mugshot
show-command-profile=true
search-actions=6

[action0]
name=Man Pages
pattern=#
command=exo-open --launch TerminalEmulator man %s
regex=false

[action1]
name=Search the Web
pattern=?
command=exo-open --launch WebBrowser https://duckduckgo.com/?q=%u
regex=false

[action2]
name=Search for Files
pattern=-
command=catfish --path=~ --start %s
regex=false

[action3]
name=Wikipedia
pattern=!w
command=exo-open --launch WebBrowser https://en.wikipedia.org/wiki/%u
regex=false

[action4]
name=Run in Terminal
pattern=!
command=exo-open --launch TerminalEmulator %s
regex=false

[action5]
name=Open URI
pattern=^(file|http|https):\\/\\/(.*)$
command=exo-open \\0
regex=true' | sudo tee -a /etc/skel/.config/xfce4/panel/whiskermenu-1.rc > /dev/null

# The rhino user is created before rhino-linux-xfce4-config is installed, so update their xfce4 configuration
rm -rf /home/rhino/.config/xfce4
mkdir -p /home/rhino/.config/xfce4
mkdir -p /home/rhino/.config/Kvantum
cp -r /etc/skel/.config/xfce4/* /home/rhino/.config/xfce4
cp -r /etc/skel/.config/Kvantum/* /home/rhino/.config/Kvantum
ln -s "/home/rhino/.config/xfce4/desktop/icons.screen0-1904x990.rc" "/home/rhino/.config/xfce4/desktop/icons.screen.latest.rc"
# Make sure the user (rhino) has wrx permissions
chmod -R 777 /home/rhino/.config/xfce4
sudo chown "rhino" -cR /home/rhino/Desktop

sudo apt-get clean
sudo apt-get remove linux*5.19* -yq
# These are not needed maybe
#sudo apt-get autoremove --purge -f -yq aspell-en aspell bolt
